<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- If this is run as a php script on a server, you can include your own header that includes a navigation bar, and other stylistic features -->
<script language="php"> include "./.inc/header.php"; if (false){ </script> 
<!-- ** start server side header ** -->
<head profile="http://www.w3.org/2005/10/profile">
<link rel="icon" type="image/ico" href="favicon.ico" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/><meta name="description" content="description"/>
<title>Open Exoplanet Catalogue</title>
<link rel="stylesheet" type="text/css" href="./css/style.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./css/tables.css" media="screen" />
<script type="text/javascript" src="./js/d3.v3.min.js"></script>
<script type="text/javascript" src="./js/rgbcolor.js"></script> 
<script type="text/javascript" src="./js/canvg.js"></script> 
<script type="text/javascript" src="./js/jquery.min.js"></script>
</head>
<body>
<div class="outer-container">
<div class="inner-container">
<div class="content">
<!-- ** end server side header ** -->
<script language="php"> } </script>
<!-- ########################### -->


<!-- ########################### -->
<div id="viz"></div>
<style>
#viz, .infobox {
    font-family: sans-serif;
}

#viz text {
    font-family: sans-serif;
    font-size: 12px;
}

</style>
<script type="text/javascript">
var M_PI = 3.1415926535897;
function get2DPositionofPlanet(planet,time){
	//if (!self.root) return GLKVector2Make(0, 0); // orphan planets
	

	var longitude 		= parseFloat($("longitude",planet).text())/180.*M_PI;
	if (isNaN(longitude)) longitude = 0.0;
	var ascendingnode 	= parseFloat($("ascendingnode",planet).text())/180.*M_PI;
	if (isNaN(ascendingnode)) ascendingnode = 0.0;
	var semimajoraxis 	= parseFloat($("semimajoraxis",planet).text());
	if (isNaN(semimajoraxis)) semimajoraxis = 0.0;
	var periastron 		= parseFloat($("periastron",planet).text())/180.*M_PI;
	if (isNaN(periastron)) periastron = 0.0;
	var period 		= parseFloat($("period",planet).text());
	if (isNaN(period)) period = 0.0;
	var eccentricity 	= parseFloat($("eccentricity",planet).text());
	if (isNaN(eccentricity)) eccentricity = 0.0;
	
	var M = longitude - periastron; 		// Mean anomaly
	if (period){
		M += 2.*M_PI*time/period;
	}else{
		M += 2.*M_PI*time/365.; 		// assume default period: 1 year
	}
	var E = M+eccentricity*Math.sin(M);		// Eccentric anomaly
	var deltaE = 0;
	var counter = 15;
	do{
		deltaE = (E - eccentricity*Math.sin(E)- M)/(1.-eccentricity*Math.cos(E));
		E -= deltaE;
		counter--;
	}while (Math.abs(deltaE)>1e-4 && counter);
	
	var _a = 1;
	if (semimajoraxis>0) _a = semimajoraxis;
	
	var xp =_a*(Math.cos(E)-eccentricity);
	var yp =_a*Math.sqrt(1.-eccentricity*eccentricity) * Math.sin(E);
	
	var sinNodengle = Math.sin(ascendingnode);
	var cosNodengle = Math.cos(ascendingnode);
	 var sinArgPeri = Math.sin(periastron-ascendingnode);
	var cosArgPeri = Math.cos(periastron-ascendingnode);
	
	var point = {
		"x": xp*(cosArgPeri*cosNodengle-sinArgPeri*sinNodengle) + yp*(-sinArgPeri*cosNodengle-cosArgPeri*sinNodengle),
		"y": xp*(cosArgPeri*sinNodengle+sinArgPeri*cosNodengle) + yp*(-sinArgPeri*sinNodengle+cosArgPeri*cosNodengle),
	};
	return point;
}
</script>
<script type="text/javascript">
var width 	= 800;
var height 	= 600;

var xmldata	= null;
var format4 = d3.format(".4f");
var format1 = d3.format(".1f");
var viz = d3.select("#viz")
	.append("svg")
	.attr("width", width)
	.attr("height", height)
	;    
viz.append("image")
	.attr("width","22")
	.attr("height","22")
	.attr("xlink:href","./img/star.png")
	.attr("x", width/2.-11)
	.attr("y", height/2.-11);

function saveaspng(){
	d3.select("body").append("canvas")
		.attr("width",width)	
		.attr("height",height)	
		.attr("id","canvas")
		.style("display","none")
		;	
	canvg('canvas', $("#viz").html());
	window.location = document.getElementById("canvas").toDataURL("image/png");
}

var t = 0;
var scale = 0;

setInterval(function() {
	t = t + 0.2;
	updatePlot(false);
 }, 10);

var drag = d3.behavior.drag()
     .origin(Object)
     .on("drag", dragmove);

viz.x = 0;
viz.y = 0;
viz.call(drag);

function dragmove(d) {
//	d3.select(this)
//		.attr("viewBox", ""+d3.event.x+" "+d3.event.y+" "+width+" "+height);
//		.attr("x", ent.x+" "+d3.event.y+" "+width+" "+height);
}

var updatePlot = function(first){ 
	var planets = $("planet",xmldata);
	if (first){
		scale = 0;
		for (var i=0;i<planets.length;i++){
			var planet = planets[i];
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			var ae = a*(1.+e);
			if (ae>scale){
				scale = ae;
			}
		}
		scale = (height/2.)/scale * 0.95;
	}

	var ellipse = viz.selectAll("ellipse")
			.data(planets);
	ellipse.enter().append("ellipse")
		.attr("rx",function(planet){
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			return scale*a;
			})
		.attr("ry",function(planet){
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			return scale*a*Math.sqrt(1.-e*e);
			})
		.attr("fill","none")
		.attr("cx",function(planet){
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			return width/2.+scale*e*a;
			})
		.attr("cy",function(planet){
			return height/2.;
			})
		.attr("transform",function(planet){
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			var peri = parseFloat($("paeriastron",planet).text()); //degrees
			return "rotate("+peri+","+width/2.+","+height/2.+")";
			})
		.attr("stroke","gray");

	ellipse.exit().remove();

	var dots = viz.selectAll("g")
			.data(planets);
	var newdots = dots.enter().append("g");
	
	newdots.append("circle")
		.attr("r",function(planet){
			var m = parseFloat($("mass",planet).text());
			return 10.*Math.pow(m,1./3.);
		});

	newdots.append("text")
		.attr("x","20")
		.attr("y","-10")
		.text(function(planet){
			return $("name",planet).first().text();
			});
	
	dots
		.attr("transform",function(planet){
			var point =get2DPositionofPlanet(planet,t);
			return "translate("+(point.x*scale+width/2.)+","+(point.y*scale+height/2.)+")";
			});
		
	dots.select("circle")
		.attr("transform",function(planet){
			var a = parseFloat($("semimajoraxis",planet).text());
			var e = parseFloat($("eccentricity",planet).text());
			var peri = parseFloat($("paeriastron",planet).text()); //degrees
			var ascendingnode 	= parseFloat($("ascendingnode",planet).text())/180.*M_PI;
			return "rotate("+(peri-ascendingnode)+","+width/2.+","+height/2.+")";
			});

	dots.exit().remove();
};

d3.xml("gj876.xml", "application/xml", function(xml) {
	xmldata = xml;
	updatePlot(true);	
});

    
</script>

<div class="spacer" style="clear:left"></div>
		<input type="button" onclick="saveaspng()" value="Save plot as png file" />

<script language="php"> include "./.inc/footer.php"; if (false){ </script> 
<!-- ** start server side header ** -->
</div> <!-- content -->
<div class="clearer">&nbsp;</div>
</div> <!-- inner container -->
</div> <!-- outer container -->
</body>
</html>
<!-- ** end server side header ** -->
<script language="php"> } </script> 
