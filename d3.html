<script language="php">
include "./.inc/header.php";
</script>
<link rel="stylesheet" type="text/css" href="./css/style.css" media="screen" />
<link rel="stylesheet" type="text/css" href="./css/tables.css" media="screen" />
<!-- ########################### -->
<h2><img src="./img/kig.png" alt="kig" />Correlation diagrams</h2>
<p>This page is currently under development. 
It uses the d3 javascript library to render correlation plots directly in your browser. 
The plots shows a scatter plot of all discovered planets.
Hover over a circle to see to which planet it corresponds. Click on it to view the planet's page.
</p>


<!-- ########################### -->
<style>
label input {
	margin-right:0.5em;
}
#viz text {
    font-family: sans-serif;
    font-size: 12px;
}
div#pop-up {
	display: none;
	position:absolute;
	color: white;
	font-size: 14px;
	background: rgba(0,0,0,0.6);
	padding: 5px 10px 5px 10px;
	-moz-border-radius: 8px 8px;
	border-radius: 8px 8px;
	width: 15em;
}
div#pop-up-title {
	font-size: 15px;
	width:200px;
	margin-bottom: 4px;
	font-weight: bolder;
}
div#pop-up-content {
	font-size: 12px;
}
</style>
<!-- ########################### -->
<div id="viz"></div>
<div id="pop-up">
        <div id="pop-up-title">Title</div>
        <div id="pop-up-content">Description</div>
</div>
<!-- ########################### -->
<div class="spacer"></div>
<table cellspacing="0" summary="Settings">
<tr>
	<th scope="column" class="nobg"> </th>
	<th scope="column" class="thname">Options<br/> <small>The plot updates automatically when an option is changed.</small> </th>
</tr>
<tr>
	<th rowspan=4 scope="row" class="spec">
		<label>x-Axis</label>
	</th>
	<td class="data">
		<select name="xaxis" onChange="updatePlot()">
		<option selected value="semimajoraxis">Semi-major axis [AU]</option>
		<option value="mass">Mass [MJup]</option>
		<option value="radius">Radius [RJup]</option>
		<option value="period">Period [days]</option>
		<option value="eccentricity">Eccentricity</option>
		<option value="temperature">Temperature [K]</option>
		<option value="inclination">Inclination [deg]</option>
		</select>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="logscalex"><input checked name="logscale" type="checkbox" value="x" id="logscalex" onClick="updatePlot()"/>Logarithmic scale</label>

	</td>
</tr>
<tr>
	<td class="data">
		<label for="xrangeauto"><input checked name="xrangeauto" type="checkbox" value="a" id="xrangeauto" onClick="xrangeUpdate()"/>Automatic range</label>
	</td>
</tr>
<tr>
	<td class="data">
		range = [<input type="text" name="xrangel" size=8 value="0" disabled onKeyUp="xrangeUpdate()"/>,
		<input type="text" name="xranger" size=8 value="0" disabled onKeyUp="xrangeUpdate()"/>]
	</td>
</tr>
<tr>
	<th rowspan=4 class="spec" scope="row">
		<label>y-Axis</label>
	</th>
	<td class="data">
		<select name="yaxis" onChange="updatePlot()">
		<option value="semimajoraxis">Semi-major axis [AU]</option>
		<option selected value="mass">Mass [MJup]</option>
		<option value="radius">Radius [RJup]</option>
		<option value="eccentricity">Eccentricity</option>
		<option value="period">Period [days]</option>
		<option value="temperature">Temperature [K]</option>
		<option value="inclination">Inclination [deg]</option>
		</select>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="logscaley"><input checked name="logscale" type="checkbox" value="y" id="logscaley" onClick="updatePlot()"/>Logarithmic scale</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="yrangeauto"><input checked name="yrangeauto" type="checkbox" value="a" id="yrangeauto" onClick="yrangeUpdate()"/>Automatic range</label>
	</td>
</tr>
<tr>
	<td class="data">
		range = [<input type="text" name="yrangel" size=8 value="0" disabled onKeyUp="yrangeUpdate()"/>,
		<input type="text" name="yranger" size=8 value="0" disabled onKeyUp="yrangeUpdate()"/>]
	</td>
</tr>
<tr>
	<th class="spec" scope="row">
		<label>Color</label>
	</th>
	<td class="data">
		<select name="coloraxis" onChange="updatePlot()">
		<option value="none" checked>None</option>
		<option value="discoverymethod">Discoverymethod</option>
		<option value="semimajoraxis">Semi-major axis [AU]</option>
		<option value="mass">Mass [MJup]</option>
		<option selected value="radius">Radius [RJup]</option>
		<option value="eccentricity">Eccentricity</option>
		<option value="period">Period [days]</option>
		<option value="temperature">Temperature [K]</option>
		<option value="inclination">Inclination [deg]</option>
		</select>
	</td>
</tr>
<tr>
	<th rowspan=6 class="spec" scope="row">
	Detection methods
	</th>
	<td class="data">
		<label for="filter_transit"><input checked name="discoveryfilter" type="checkbox" value="transit" id="filter_transit" onClick="updatePlot()"/>Transiting planets</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="filter_rv"><input checked name="discoveryfilter" type="checkbox" value="RV" id="filter_rv" onClick="updatePlot()"/>Radial velocity planets</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="filter_microlensing"><input checked name="discoveryfilter" type="checkbox" value="microlensing" id="filter_microlensing" onClick="updatePlot()"/>Microlensing planets</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="filter_imaged"><input checked name="discoveryfilter" type="checkbox" value="imaging" id="filter_imaged" onClick="updatePlot()"/>Directly imaged planets</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="filter_timing"><input checked name="discoveryfilter" type="checkbox" value="timing" id="filter_timing" onClick="updatePlot()"/>Planets found by pulsar timing</label>
	</td>
</tr>
<tr>
	<td class="data">
		<label for="filter_other"><input checked name="discoveryfilter" type="checkbox" value="" id="filter_other" onClick="updatePlot()"/>Planets found by other methods</label>
	</td>
</tr>
<tr>
	<th rowspan=6 class="spec" scope="row">
	Export
	</th>
	<td class="data">
		<input type="button" onClick="saveaspng()" value="Save plot as png file" />
	</td>
</tr>
</table>
<!-- ########################### -->
<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/rgbcolor.js"></script> 
<script type="text/javascript" src="http://canvg.googlecode.com/svn/trunk/canvg.js"></script> 
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
var width 	= 600;
var height 	= 500;
var paddingt 	= 10;
var paddingb 	= 45;
var paddingl 	= 65;
var paddingr 	= 10;

var first 	= true;
var planetsxml	= null;
var viz = d3.select("#viz")
	.append("svg")
	.attr("width", width)
	.attr("height", height)
	;    
var gxaxis = viz.append("g")
	.attr("transform", "translate(0," + (height - paddingb-paddingt) + ")");
	;
var gyaxis = viz.append("g")
	.attr("transform", "translate(" + paddingl + ", 0)")
	;
var gxaxislabel = viz.append("text")
	.attr("text-anchor", "middle")
	.attr("x", width/2.)
	.attr("y", height - 6)
	;
var gyaxislabel = viz.append("text")
	.attr("text-anchor", "middle")
	.attr("x", -height/2.)
	.attr("y", 12)
	.attr("transform", "rotate(-90)")
	;
	
function saveaspng(){
	d3.select("body").append("canvas")
		.attr("width",width)	
		.attr("height",height)	
		.attr("id","canvas")
		.style("display","none")
		;	
	canvg('canvas', $("#viz").html());
	var canvas = document.getElementById("canvas");
	window.location = canvas.toDataURL("image/png");
}
	
var xDomain;
var yDomain;

function xrangeUpdate(){
	if(d3.select("#xrangeauto").node().checked){
		d3.select("[name=xrangel]").attr("disabled",true);
		d3.select("[name=xranger]").attr("disabled",true);
		updatePlot();
	}else{
		d3.select("[name=xrangel]").attr("disabled",null);
		d3.select("[name=xranger]").attr("disabled",null);
		var newxDomain = [ parseFloat(d3.select("[name=xrangel]").node().value), parseFloat(d3.select("[name=xranger]").node().value) ];
		if (newxDomain[0]!=xDomain[0] || newxDomain[1]!=xDomain[1]){
			xDomain = newxDomain;
			updatePlot();
		}
	}
}
function yrangeUpdate(){
	if(d3.select("#yrangeauto").node().checked){
		d3.select("[name=yrangel]").attr("disabled",true);
		d3.select("[name=yranger]").attr("disabled",true);
		updatePlot();
	}else{
		d3.select("[name=yrangel]").attr("disabled",null);
		d3.select("[name=yranger]").attr("disabled",null);
		var newyDomain = [ parseFloat(d3.select("[name=yrangel]").node().value), parseFloat(d3.select("[name=yranger]").node().value) ];
		if (newyDomain[0]!=yDomain[0] || newyDomain[1]!=yDomain[1]){
			yDomain = newyDomain;
			updatePlot();
		}
	}
}

var colorkey;
var colorScale;

function getColor(d){
	var elem = d.getElementsByTagName(colorkey);
	if (!elem.length) return undefined;
	return	parseFloat($(elem).text()); 
}
function color(d){
	var elem = d.getElementsByTagName(colorkey);
	if (!elem.length) return "gray";
	var text = $(elem[0]).text();
	if (colorkey=="discoverymethod"){
		if (text=="RV") return "red";
		if (text=="transit") return "green";
		if (text=="imaging") return "blue";
		if (text=="timing") return "yellow";
		if (text=="microlensing") return "purple";
	}else{
		return d3.hsl(120.-colorScale(parseFloat(text)), 1, 0.5);
	}
}

var updatePlot = function(){ 
	var discoveryfilter = d3.selectAll("input[name=discoveryfilter]:checked");
	var xkey = d3.select("select[name=xaxis]").node().options[d3.select("select[name=xaxis]").node().selectedIndex].value;
	var ykey = d3.select("select[name=yaxis]").node().options[d3.select("select[name=yaxis]").node().selectedIndex].value;
	colorkey = d3.select("select[name=coloraxis]").node().options[d3.select("select[name=coloraxis]").node().selectedIndex].value;

	var logscalex = d3.select("#logscalex").node().checked;
	var logscaley = d3.select("#logscaley").node().checked;

	
	var planets = planetsxml.filter(function(d,i) {
		var discoverymethod = d.getElementsByTagName("discoverymethod");
		if (!discoverymethod.length){
			discoverymethod = "";
		}else{
			discoverymethod = $(discoverymethod[0]).text();
		}
		var isInSelection = false;
		discoveryfilter[0].forEach(function(d){
			if(d.value==discoverymethod){
				isInSelection = true;
			}
		});
		if (!isInSelection){
			return false;
		}
		var tagx = d.getElementsByTagName(xkey);
		if(!tagx.length) return false;
		if(logscalex && $(tagx[0]).text()<=0.) return false;
		var tagy = d.getElementsByTagName(ykey);
		if(!tagy.length) return false;
		if(logscaley && $(tagy[0]).text()<=0.) return false;
		return true;
	});
	if(d3.select("#xrangeauto").node().checked){
		xDomain = d3.extent(planets, function(d) { 
				return	parseFloat($(d.getElementsByTagName(xkey)[0]).text()); 
			});
		d3.select("[name=xrangel]").node().value = xDomain[0];
		d3.select("[name=xranger]").node().value = xDomain[1];
	}

	if(d3.select("#yrangeauto").node().checked){
		yDomain = 
			d3.extent(planets, function(d) { 
				return	parseFloat($(d.getElementsByTagName(ykey)[0]).text()); 
			});
		d3.select("[name=yrangel]").node().value = yDomain[0];
		d3.select("[name=yranger]").node().value = yDomain[1];
	}

	var colorDomain = [
		d3.min(planets, function(d) { 
			return getColor(d);
		}),
		d3.max(planets, function(d) { 
			return getColor(d);
		})
		];

	var xScale;
	if (logscalex){
		xScale = d3.scale.log();
	}else{
		xScale = d3.scale.linear();
	}
	xScale.domain(xDomain)
		.clamp(true)
		.range([paddingl, width-paddingl-paddingr]);
	var yScale;
	if (logscaley){
		yScale = d3.scale.log();
	}else{
		yScale = d3.scale.linear();
	}
	yScale.domain(yDomain)
		.clamp(true)
		.range([height - paddingb-paddingt,paddingt]);
	colorScale = d3.scale.linear()
		.domain(colorDomain)
		.range([0,120]);


  	var circle = viz.selectAll("circle")
		.data(planets,function(d) {return $(d.getElementsByTagName("name")[0]).text(); });

	circle.enter().append("circle")
		.attr("r", 4.)
		.style("stroke", "black")
		.style("opacity",0)
		.attr("cx", function(d) { return xScale($(d.getElementsByTagName(xkey)[0]).text()); })
		.attr("cy", function(d) { return yScale($(d.getElementsByTagName(ykey)[0]).text()); })
		.style("fill", function(d) { return color(d); })
		.on("click", function(d) {
			document.location.href = "/system.php?id=" + $(d.getElementsByTagName("name")[0]).text();
		})
		.on("mouseout", function(d){
			d3.select("#pop-up").style("display","none");
		})
		.on("mousemove", function(){
			d3.select("#pop-up").style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");
		})
		.on("mouseover", function(d){
			var name = $(d.getElementsByTagName("name")[0]).text();
			var description = $(d.getElementsByTagName("description")[0]).text();
			d3.select("#pop-up").style("display","inline");
			d3.select("#pop-up-title").html(name);
			if (description){
				d3.select("#pop-up-content").html(description);
			}else{
				d3.select("#pop-up-content").html("");
			}
		})
		;


	circle
		.transition()
		.attr("cx", function(d) { return xScale($(d.getElementsByTagName(xkey)[0]).text()); })
		.attr("cy", function(d) { return yScale($(d.getElementsByTagName(ykey)[0]).text()); })
		.style("fill", function(d) { return color(d); })
		.style("opacity",1)
		;

	circle.exit()
		.transition()
		.style("opacity",0)
		.remove();


	var xlabel = d3.select("select[name=xaxis]").node().options[d3.select("select[name=xaxis]").node().selectedIndex].text;
	var ylabel = d3.select("select[name=yaxis]").node().options[d3.select("select[name=yaxis]").node().selectedIndex].text;
	
	var xAxis = d3.svg.axis()
		.scale(xScale)
		.ticks(5)
		.orient("bottom");
	var yAxis = d3.svg.axis()
		.scale(yScale)
		.ticks(5)
		.orient("left");

	if (first){
		gxaxis.call(xAxis);
		gyaxis.call(yAxis);
	}else{
		gxaxis.transition().call(xAxis);
		gyaxis.transition().call(yAxis);
	}
	gxaxis.selectAll("path,line")
		.style("fill","none")
		.style("stroke","black");
	gyaxis.selectAll("path,line")
		.style("fill","none")
		.style("stroke","black");
			
	gxaxislabel.text(xlabel);
	gyaxislabel.text(ylabel);

	first = false;
};

d3.xml("systems.xml", "application/xml", function(xml) {
	planetsxml = d3.select(xml).selectAll("planet")[0];
	updatePlot();	
});

    
</script>

<!-- ########################### -->
<h2><img src="./img/xml.png" alt="star" />Data download</h2>
<p>
The data presented in this plot is taken from the <a href="https://github.com/hannorein/open_exoplanet_catalogue">Open Exoplanet Catalogue</a>. All information on this page is directly generated from the XML files in the catalogue. If you are interested in how, look at the source code. You can download the entire catalogue on <a href="https://github.com/hannorein/open_exoplanet_catalogue/">github</a>. You can also find ASCII tables of the same catalogue <a href="https://github.com/hannorein/oec_tables/">in a separate repository</a>. Some information, especially in the case of a binary system cannot be easily represented in an ASCII table. You are therefore encouraged to use the original XML files provided by the Open Exoplanet Catalogue. 
</p>
<?
include "./.inc/footer.php";
?>
